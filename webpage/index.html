<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <title>Crystal: Proactive Conflict Detector for Distributed Version Control</title>
<style type="text/css">
body
{
background-color:#FFFF99
}
</style>
</head>

<body>

<h1 id="Crystal:_Distributed_Version_Control_Speculative_Conflict_Detector"><img src="crystal-ball_blue_128.png" alt="Crystal ball"/> Crystal: Proactive Conflict Detector for Distributed Version Control</h1>

 
<p>Contents:</p>
<!-- start toc.  do not edit; run html-update-toc instead -->
    <ul>
      <li><a href="#motivation">Goal: Increased developer awareness of conflicts</a></li>
      <li><a href="#Requirements">Requirements</a></li>
      <li><a href="#download">How to run Crystal</a></li>
      <li><a href="#screen-shot">Crystal screen shot</a>
        <ul>
          <li><a href="#local-state">Local state</a></li>
          <li><a href="#relationship">Relationship</a></li>
          <li><a href="#action">Action</a></li>
          <li><a href="#guidance">Guidance</a></li>
        </ul></li>
      <li><a href="#Configuration_File_Format">Configuration file format</a></li>
      <li><a href="#access-to-remote-repos">Making your repository available to your co-workers</a>
        <ul>
          <li><a href="#copying-repository">Making a copy of your repository</a></li>
        </ul></li>
      <li><a href="#password-request">Why does Crystal keep asking me for a password?</a></li>
      <li><a href="#Acknowledgements">Acknowledgements</a></li>
      <li><a href="#Contacts">Contacts</a></li>
    </ul>
<!-- end toc -->


<h2 id="motivation">Goal: Increased developer awareness of conflicts</h2>

<p>
The Crystal tool increases developer awareness of potential version control conflicts.  For example, it informs a developer of the answer to the question, &#8220;Might my changes conflict with others' changes?&#8221;
</p>

<p>
Crystal keeps an eye on all the participating developers' repositories.  It informs each developer when it is safe to push her changes, when she has fallen behind and could pull changes from others or a central repository, and when changes other developers have made will cause a syntactic (or, soon to be implemented, behavioral) conflict.
</p>
<ul>
<li>If conflicts occur, Crystal informs developers early, so they may discuss and resolve these conflicts while the causes are fresh in their minds.  Long-established conflicts can be much harder to resolve.</li>
<li>If changes are made (locally or remotely) without conflicts, Crystal increases developers' confidence that the changes will not cause problems for the team.</li>
</ul>

<p>
Crystal examines commits.  It does not examine your working copy &mdash;
your uncommitted modifications.  The reason is that commits are more likely
to be coherent and desired units of work, for which notification about
(non-)conflicts is of value.
</p>

<p>
The Crystal client is now in beta and is available for <a href="#download">download</a>.
</p>

<h2 id="Requirements">Requirements</h2>

<ul>
<li> <a href="http://java.sun.com/javase/downloads/index.jsp">JRE (Java Runtime Environment).</a></li>
<li> <a href="http://mercurial.selenic.com">Mercurial</a>, version <b>1.6 or later</b>. (Crystal only supports Mercurial, for now.)</li>
<li> The fetch mercurial extension must be enabled.  To do this, add the following text to your hg configuration file: <tt>~/.hgrc</tt> on Linux, or <tt>mercurial.ini</tt> on Windows.  (There is nothing after the "<tt>=</tt>" in "<tt>fetch=</tt>".)
<pre>
[extensions]
fetch=
</pre></li>
<li> The more of your co-workers' repositories you have read access to, the
  more useful Crystal will be.  However, Crystal can be useful even if you
  only have access to your repository's parent.</li>
</ul>


<h2 id="download">How to run Crystal</h2>

<ol>
<li> Download <a href="crystal.jar">crystal.jar</a>. (Current version is 0.1.20101222.  To learn the version of an executable, run <tt>java -jar crystal.jar --version</tt> or select the <tt>about</tt> menu in the GUI.)</li>
<li> Run:  <tt>java -jar crystal.jar</tt></li>
<li> The tool will complain that your configuration file is invalid and
  give you instructions on how to fix it.  You can do so either via a GUI
  that creates the configuration file for you, or by editing the
  configuration file directly.  See below for the
  <a href="#Configuration_File_Format">configuration file format</a>.</li>
<li> Restart Crystal.  Crystal will run as an icon in your task bar.  Click on the icon to see the full client and more options.</li>
</ol>

<h2 id="screen-shot">Crystal screen shot</h2>

<p>
Crystal displays four types of information: local state, relationship, possible action, and guidance.  
</p>

<p>
<img src="CrystalScreenShot.png" alt="A screen shot of the Crystal tool."></img>
</p>

<h3 id="local-state">Local state</h3>

<p>
The working copy can be in one of three states, shown below the project name: 
</p>
<ol>
<li> UNCHECKPOINTED (denoted as <tt>hg commit</tt>)</li>
<li> MUST RESOLVE (denoted as <tt>hg fetch</tt>)</li>
<li> ALL CLEAR (denoted as a blank)</li>
</ol>

<h3 id="relationship">Relationship</h3>

<p>
There are five possible relationships (plus two descriptors) between the developer's repository and that of a collaborate.  This relationship determines the shape of the icon Crystal displays.  
</p>

<table border="2" width="640" cellpadding="10">
  <tr>
    <th align="center">Crystal shape</th>
    <th align="center">Meaning of the shape</th>
  </tr>
  <tr>
    <td align="center"><img src="same.png" height="48" alt="green checkmark"></img></td>
    <td align="left">SAME: The repositories are in sync.</td>
  </tr>
  <tr>
    <td align="center"><img src="ahead.png" height="48" alt="push arrow"></img></td>
    <td align="left">AHEAD: Your repository has newer commits than the other one.  You may consider pushing your changes or letting the owner know.</td>
  </tr>
  <tr>
    <td align="center"><img src="behind.png" height="48" alt="pull arrow"></img></td>
    <td align="left">BEHIND: The other repository has newer commits than yours.  You may consider pulling changes to avoid later merges.</td>
  </tr>
  <tr>
    <td align="center"><img src="merge.png" height="48" alt="yellow merge"></img></td>
    <td align="left">MERGE: Each of the two repositories has commits not present in the other one, but they can be merged cleanly. </td>
  </tr>
  <tr>
    <td align="center"><img src="mergeconflict.png" height="48" alt="red merge"></img></td>
    <td align="left">CONFICT: Each of the two repositories has commits not present in the other one and merging them will result in a textual conflict. </td>
  </tr>
  <tr>
    <td align="center"><img src="clock.png" height="48" alt="clock"></img></td>
    <td align="left">Crystal is in the process of refreshing this data. </td>
  </tr>
  <tr>
    <td align="center"><img src="error.png" height="48" alt="error"></img></td>
    <td align="left">Crystal experienced an error in computing this relationship. </td>
  </tr>



  <!-- tr
    <td align="center"><img src="compileconflict.png" height="48" alt="red merge with a C"></img></td>
    <td align="left"><b>Not currently implemented.</b>  Both repositories have new commits and merging them does not result in a textual conflict but the result does not compile. </td>
  </tr>
  <tr>
    <td align="center"><img src="testconflict.png" height="48" alt="red merge with a T"></img></td>
    <td align="left"><b>Not currently implemented.</b>  Both repositories
    have new commits and merging them does not result in a textual or
    compilation conflict, but the result does not pass at least one test
    that either your or the other repository passes. </td>
  </tr>
  -->
</table>

<h3 id="action">Action</h3>

<p>
Holding the mouse over an icon displays a tool tip.  At the top of the tool tip, Crystal shows the action the developer may perform, if one is available (e.g., <tt>hg commit</tt>, <tt>hg merge</tt>, <tt>hg fetch</tt>, and <tt>hg push</tt>).
</p>

<h3 id="guidance">Guidance</h3>

<p>
There are five types of guidance Crystal displays:
</p>
<ol>
<li> Committer: the list of committers relevant to the relationship.  Crystal displays this information in the tool tip.</li>
<li> When: whether or not the developer can act right now to affect this relationship.  The relationship icon is solid if the developer can act now, and hollow if the developer cannot act until later.</li>
<li> Capable: whether or not the developer must, might, or cannot act to affect the relationship.  The relationship icon is solid if the developer must be the one to take action, solid but unsaturated if the developer might be the one to take action, and hollow if the developer cannot be the one to take action.</li>
<li> Consequences: the new relationship after the developer executes the available action.  Crystal displays this information in the tool tip.</li>
<li> Ease: Whether another developer may have an easier time affecting this relationship.Crystal displays this information in the tool tip.</li>
</ol>

<p>
In the task bar, Crystal displays the most severe icon that appears
anywhere in the full window.
</p>


<h2 id="Configuration_File_Format">Configuration file format</h2>

<p>The Crystal configuration file is an XML file that describes the locations of the scratch space and the <tt>hg</tt> executable, as well as contains information on the repositories crystal monitors.
On a Unix-like environment, it appears in <tt>~/.conflictClient.xml</tt>.
On a Windows environment, it appears in the user's home directory , e.g., <tt>C:\Users\$USER\.conflictClient.xml</tt>.
</p>

<p>
Here is an example valid configuration file:
</p>

<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;ccConfig tempDirectory=&quot;C:/temp/conflictClient/&quot; hgPath=&quot;C:/Program Files/TortoiseHg/hg.exe&quot;&gt;
  &lt;project Kind=&quot;HG&quot; ShortName=&quot;MyFirstProject&quot; Clone=&quot;C:/projects/MyLocalFirstProjectRepo/&quot; parent=&quot;MASTER&quot;&gt;
    &lt;source ShortName=&quot;MASTER&quot; Clone=&quot;ssh://user@host/path/to/repo/&quot; commonParent=&quot;MASTER&quot; /&gt;
    &lt;source ShortName=&quot;Friend&quot; Clone=&quot;ssh://user@host/path/to/friend/repo/&quot; commonParent=&quot;MASTER&quot; /&gt;
  &lt;/project&gt;
  &lt;project Kind=&quot;HG&quot; ShortName=&quot;MySecondProject&quot; Clone=&quot;C:/projects/MyLocalSecondProjectRepo/&quot; parent=&quot;MASTER&quot;&gt;
    &lt;source ShortName=&quot;MASTER&quot; Clone=&quot;ssh://user@host/path/to/socond/project/repo/&quot; commonParent=&quot;MASTER&quot; /&gt;
    &lt;source ShortName=&quot;Friend&quot; Clone=&quot;https://user@host/path/to/friend/second/repo&quot; commonParent=&quot;MASTER&quot; /&gt;
  &lt;/project&gt;
&lt;/ccConfig&gt;
</pre>

<p>
At the root level, there is a single XML element: <tt>ccConfig</tt>.  This element has two attributes: <tt>tempDirectory</tt> and <tt>hgPath</tt>.  These attributes show the path to the scratch space and the hg executable, respectively.
</p>

<p>
For each project you wish Crystal to track, <tt>ccConfig</tt> will have a <tt>project</tt> child with four attributes: <tt>Kind</tt>, <tt>ShortName</tt>, <tt>Clone</tt>, and (optionally) <tt>parent</tt>.  The <tt>Kind</tt> element describes the kind of the repository: HG for mercurial or GIT for git, although, for now, Crystal only supports HG.  The <tt>ShortName</tt> element is the name of the project you want Crystal to display (on the left side on the screen shot above).  The <tt>Clone</tt> element is the path to your local repository; you can put any address that can legally go after the <tt>&quot;hg clone&quot;</tt> command.  The optional <tt>parent</tt> element is the shortName of the repository that is your repository's parent; that is, the default place you push to and pull from.  Crystal needs to know the parent to determine your possible actions; if you do not supply the <tt>parent</tt> attribute, Crystal will not report the action information.  
</p>

<p>
Finally, for each repository you wish Crystal to compare to your repository, the <tt>project</tt> element will have a <tt>source</tt> child with three attributes: <tt>ShortName</tt>, <tt>Clone</tt>, and (optionally) <tt>commonParent</tt>.  The <tt>ShortName</tt> element is the name of the repository you want Crystal to display (above the icons on the screen shot above).  The <tt>Clone</tt> element is the path to this repository; again, you can put any address that can legally go after the <tt>&quot;hg clone&quot;</tt> command.  The optional <tt>commonParent</tt> element is the shortName of the repository that is the common parent between your repository and the repository this <tt>source</tt> element represents.  Most often, the common parent is the master repository.  Crystal needs to know the common parent to determine the guidance information; if you do not supply the <tt>commonParent</tt> attribute, Crystal will not report any guidance and all relationship icons will appear solid.  
</p>

<h2 id="access-to-remote-repos">Making your repository available to your co-workers</h2>

<p>
The more of your co-workers' repositories you have read access to, the
more useful Crystal will be.  This section explains how to make your
repositories (your clones) available to a co-worker.
</p>

<p>
If you and your co-worker have access to the same file system, then you can
use the "File system sharing" technique.
If you have access to a machine that runs a web server, then you can use
the "Http sharing" technique.
You can always use the "Dropbox sharing" technique.
</p>

<!--
Your coworker can access your clones either via a file system or via http.
(This corresponds to the different types of URLs that can be passed to the
<tt>hg clone</tt> command.)
-->

<dl>
<dt>File system sharing</dt>
<dd>
If you and your co-worker have access to the same file system, then you can
store your repository in a place where your co-worker can read it.
<br />
You can either grant your co-worker read permission to your repository, or
you can <a href="#copying-repository">copy</a> your repository to a
location that your co-worker can read.
</dd>

<dt>Dropbox sharing</dt>
<dd>
You can use the <a href="http://www.dropbox.com/">Dropbox</a> file sharing
service to share your repository with your co-workers.  This approach has
several benefits:  changes are copied immediately, and the same technique
works for all co-workers.  For full details, see the document
<a href="using-dropbox.html">Sharing repositories using Dropbox</a>.
</dd>

<dt>Http sharing</dt>
<dd>
The http sharing approach is often easier, but it only works if you have
access to a machine that runs a web server.  Either 
make your repository accessible via http, or periodically <a href="#copying-repository">copy</a> your
repository to a location that is accessible via http.
In other words, the location will be a directory that has a <tt>http:</tt> URL.
<ul>
<li>
To make your repository accessible via http, one way is to make 
a symbolic link from your <tt>~/public_html</tt> directory (this may
requires changing access permissions so the web server can read your
repository).
</li>
<li>
If you make a copy of your repository, then don't
forget to make <tt>.../accessible-path/</tt> and all subdirectories
readable by the web server (example: <tt>chmod -R og+r
  .../accessible-path</tt>), and also enable the web server to show a
directory listing to the hg client (example: add <tt>+Indexes</tt> to file
<tt>.../accessible-path/.htaccess</tt>).
</li>
</ul>
</dd>
</dl>

<h3 id="copying-repository">Making a copy of your repository</h3>

<p>
If you choose to make a copy of your repository in an accessible location,
then the more frequently you update the copy, the more useful Crystal is.
Here is a line you can place in your crontab file to automate the task:
</p>
<pre>
# Update a public copy of a .hg directory every minute.
* * * * *	rsync -a .../path-to-repo/.hg .../accessible-path
</pre>
<p>
The <tt>.hg</tt> file will end up as <tt>.../accessible-path/.hg</tt>, and
the path to the repository is just <tt>.../accessible-path</tt>.
</p>

<p>
The <tt>rsync</tt> program even permits the destination path to be on a
different computer, in which case it looks like 
<tt><em>machinename</em>:<em>filename</em></tt>, for example
<tt>barb.cs.washington.edu:/homes/gws/mernst/www/crystal-repositories/...</tt>
</p>

<h2 id="password-request">Why does Crystal keep asking me for a password?</h2>

<p>
Crystal creates local clones of the repositories you specify in your configuration file.  If accessing those repositories (e.g., if running <tt>hg clone ...</tt> or <tt>hg pull</tt>) prompts you for a password, then Crystal will forward that prompt to you.  Because Crystal performs a pull every time it computes its relationships, entering the password may become burdensome.  
</p>

<p>
Depending on how you access your repositories, there are ways to get around entering your password every time:  
</p>
<ul>
<li>If you are using ssh to access the repositories, you can set up ssh agent. See these <a href="http://mah.everybody.org/docs/ssh">instructions</a> for how to set up ssh agent.</li>  
<li>If you are using http or https to access the repositories, you can enter the passwords within your mercurial configuration files.  See these <a href="http://mercurial.selenic.com/wiki/FAQ#FAQ.2BAC8-CommonProblems.How_can_I_store_my_HTTP_login_once_and_for_all_.3F">instructions</a> for setting up http/https passwords; however, beware that they require storing your passwords in plain text within the configuration files.</li>
</ul>  


<h2 id="Acknowledgements">Acknowledgements</h2>

<p>
This work is supported by 
Microsoft Research through the Software Engineering Innovation Foundation grant, 
by the National Science Foundation under Grant# 0963757 and Grant #0937060 to the Computing Research Association for the CIFellows Project, 
by the National Science and Engineering Research Council Postdoctoral Fellowship, 
and by IBM through a John Backus Award.
</p>

<h2 id="Contacts">Contacts</h2>

<p>
Crystal is designed and developed by <a href="http://www.cs.washington.edu/homes/brun">Yuriy Brun</a>, <a href="http://www.cs.washington.edu/homes/rtholmes">Reid Holmes</a>, <a href="http://www.cs.washington.edu/homes/mernst">Michael Ernst</a>, and <a href="http://www.cs.washington.edu/homes/notkin">David Notkin</a>.
<br/>
<a href="mailto:brun@cs.washington.edu">Email us</a> with any questions.
</p>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-7528475-1");
pageTracker._trackPageview();
} catch(err) {}</script>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-7528475-4");
pageTracker._trackPageview();
} catch(err) {}</script>


</body>
</html>

<!--  LocalWords:  JRE hgrc hg xml UTF ccConfig tempDirectory hgPath Kind ini
 -->
<!--  LocalWords:  ShortName FirstProject Clone SecondProject cp fpru
 -->
<!--  LocalWords:  scp rsync
 -->
